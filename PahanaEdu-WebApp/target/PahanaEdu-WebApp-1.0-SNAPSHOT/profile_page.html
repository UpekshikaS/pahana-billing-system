<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Profile</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="style.css">
    </head>
    <body class="bg-gray-100 p-6">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">My Profile</h2>
            <div id="message-area" class="hidden mb-4 p-3 rounded-md"></div>
            <form id="profile-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" disabled class="form-input mt-1 bg-gray-100">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="name" required class="form-input mt-1">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="form-input mt-1">
                    </div>
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="phone" class="form-input mt-1">
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <textarea id="address" rows="3" class="form-input mt-1"></textarea>
                </div>
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-900">Change Password</h3>
                    <p class="mt-1 text-sm text-gray-500">Leave blank if you don't want to change your password.</p>
                    <div class="mt-4">
                        <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" id="new-password" class="form-input mt-1">
                    </div>
                </div>
                <div class="text-right">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
        <script>
            (() => {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                const API_BASE_URL = 'http://localhost:8080/PahanaEdu-BookShop-Server/api';
                const form = document.getElementById('profile-form');
                const messageArea = document.getElementById('message-area');

                if (!loggedInUser) {
                    window.location.href = 'login.html';
                    return;
                }

                document.getElementById('username').value = loggedInUser.username;
                document.getElementById('name').value = loggedInUser.name || '';
                document.getElementById('email').value = loggedInUser.email || '';
                document.getElementById('phone').value = loggedInUser.phone || '';
                document.getElementById('address').value = loggedInUser.address || '';

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const button = form.querySelector('button[type="submit"]');
                    button.disabled = true;
                    button.textContent = 'Saving...';

                    const requestBody = {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        address: document.getElementById('address').value,
                        newPassword: document.getElementById('new-password').value || null
                    };

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/profile/${loggedInUser.userId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(requestBody)
                        });
                        const result = await response.json();
                        if (!response.ok)
                            throw new Error(result.error);

                        loggedInUser.name = requestBody.name;
                        loggedInUser.email = requestBody.email;
                        loggedInUser.phone = requestBody.phone;
                        loggedInUser.address = requestBody.address;
                        sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

                        messageArea.textContent = 'Profile updated successfully!';
                        messageArea.className = 'mb-4 p-3 rounded-md bg-green-100 text-green-800';
                        messageArea.classList.remove('hidden');
                        document.getElementById('new-password').value = '';
                    } catch (error) {
                        messageArea.textContent = `Error: ${error.message}`;
                        messageArea.className = 'mb-4 p-3 rounded-md bg-red-100 text-red-800';
                        messageArea.classList.remove('hidden');
                    } finally {
                        button.disabled = false;
                        button.textContent = 'Save Changes';
                    }
                });

            })();
        </script>
    </body>
</html>
