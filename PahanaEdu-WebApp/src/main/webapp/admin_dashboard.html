<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - PahanaEdu Book Shop</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <style>
            body {
                font-family: 'Inter', sans-serif;
            }
            .sidebar-scroll::-webkit-scrollbar {
                width: 4px;
            }
            .sidebar-scroll::-webkit-scrollbar-track {
                background-color: #f1f5f9;
            }
            .sidebar-scroll::-webkit-scrollbar-thumb {
                background-color: #94a3b8;
                border-radius: 10px;
            }
            .nav-link.active {
                background-color: #eef2ff;
                color: #4f46e5;
                font-weight: 600;
            }
        </style>
    </head>
    <body class="bg-gray-100">

        <div id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-white shadow-lg z-20 transition-transform transform -translate-x-full md:translate-x-0">
            <div class="px-6 py-4 flex items-center space-x-3">
                <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                <h2 class="text-2xl font-bold text-gray-800">PahanaEdu</h2>
            </div>
            <nav id="sidebar-nav" class="mt-6 px-4 sidebar-scroll overflow-y-auto h-[calc(100%-150px)]">
                <a href="#" data-page="billing_page_integrated.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <i class="fas fa-file-invoice-dollar w-6 text-center"></i><span class="mx-4">Billing / Invoicing</span>
                </a>
                <a href="#" data-page="returns_page_ui.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <i class="fas fa-undo w-6 text-center"></i><span class="mx-4">Process Returns</span>
                </a>
                <a href="#" data-page="customer_management_integrated.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <i class="fas fa-users w-6 text-center"></i><span class="mx-4">Customers</span>
                </a>

                <div id="admin-links" class="hidden">
                    <p class="px-4 mt-4 mb-2 text-xs text-gray-500 uppercase">Admin Tools</p>
                    <a href="#" data-page="stock_management_integrated.html" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-boxes-stacked w-6 text-center"></i><span class="mx-4">Stock Management</span>
                    </a>
                    <a href="#" data-page="user_management_integrated.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-user-shield w-6 text-center"></i><span class="mx-4">User Management</span>
                    </a>
                    <a href="#" data-page="reports_page_ui.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-chart-pie w-6 text-center"></i><span class="mx-4">Reports</span>
                    </a>
                    <a href="#" data-page="invoice_list.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-file-invoice w-6 text-center"></i><span class="mx-4">Invoices</span>
                    </a>
                    <a href="#" data-page="notifications.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-bell w-6 text-center"></i><span class="mx-4">Notifications</span>
                    </a>
                    <a href="#" data-page="help.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-circle-question w-6 text-center"></i><span class="mx-4">Help</span>
                    </a>

                </div>
            </nav>
            <div class="absolute bottom-0 left-0 w-full p-4 border-t">
                <a href="#" data-page="profile_page.html" class="nav-link flex items-center mt-4 px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <i class="fas fa-user-circle w-6 text-center"></i><span id="profile-name" class="mx-4">My Profile</span>
                </a>
            </div>
        </div>

        <div class="md:ml-64 transition-all duration-300">
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                <button id="menu-toggle" class="text-gray-600 md:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 id="page-title" class="text-xl font-semibold text-gray-800">Billing / Invoicing</h1>
                <div class="relative">

                </div>
                <div class="flex items-center space-x-1">
                    <button id="notification-bell" class="text-gray-600 hover:text-indigo-600">
                        <i class="fas fa-bell fa-lg mr-8"></i>
                    </button>
                    <span id="notification-badge" class="absolute top-5 right-39 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">
                        0
                    </span>
                    <button id="logout-button" class="flex items-center text-sm font-medium text-gray-600 hover:text-indigo-600">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </header>

            <main id="main-content" class="p-6">
            </main>
        </div>

        <script>
            (() => {
                const mainContent = document.getElementById('main-content');
                const pageTitle = document.getElementById('page-title');
                const navLinks = document.querySelectorAll('.nav-link');
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.getElementById('menu-toggle');
                const notificationBell = document.getElementById('notification-bell');
                const notificationBadge = document.getElementById('notification-badge');

                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                const apiBaseUrl = "http://localhost:8080/PahanaEdu-BookShop-Server/api";

                if (!loggedInUser) {
                    alert('You are not logged in. Redirecting to login page.');
                    window.location.href = 'login.html';
                    return;
                }

                if (loggedInUser.role === 'ADMIN') {
                    document.getElementById('admin-links').classList.remove('hidden');
                }

                document.getElementById('profile-name').textContent = loggedInUser.name || loggedInUser.username;


                const loadPage = async (pageUrl) => {
                    mainContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div></div>';

                    try {
                        const response = await fetch(`${pageUrl}?_=${Date.now()}`);
                        if (!response.ok) {
                            throw new Error(`Could not load page. Status: ${response.status}`);
                        }

                        const pageContent = await response.text();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = pageContent;

                        const bodyElement = tempDiv.querySelector('body');
                        if (bodyElement) {
                            mainContent.innerHTML = bodyElement.innerHTML;
                        } else {
                            mainContent.innerHTML = pageContent;
                        }

                        const scripts = tempDiv.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.textContent = script.textContent;
                            }

                            [...script.attributes].forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });

                            document.body.appendChild(newScript);
                            if (!script.src) {
                                newScript.parentNode.removeChild(newScript);
                            }
                        });


                    } catch (error) {
                        console.error('Failed to load page:', error);
                        mainContent.innerHTML = `<div class="text-center text-red-500"><p>Error loading page.</p><p>${error.message}</p></div>`;
                    }
                };

                window.fetchUnreadNotificationCount = async () => {
                    if (!loggedInUser || !loggedInUser.userId) {
                        notificationBadge.classList.add('hidden');
                        return;
                    }
                    try {
                        const response = await fetch(`${apiBaseUrl}/notifications/unread/${loggedInUser.userId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch unread notifications');
                        }
                        const notifications = await response.json();
                        const unreadCount = notifications.length;

                        if (unreadCount > 0) {
                            notificationBadge.textContent = unreadCount;
                            notificationBadge.classList.remove('hidden');
                        } else {
                            notificationBadge.classList.add('hidden');
                        }
                    } catch (error) {
                        console.error("Error fetching unread notifications:", error);
                    }
                };

                document.getElementById('sidebar-nav').addEventListener('click', (e) => {
                    const link = e.target.closest('.nav-link');
                    if (!link)
                        return;

                    e.preventDefault();

                    const pageUrl = link.dataset.page;
                    if (!pageUrl)
                        return;

                    sessionStorage.setItem('currentPage', pageUrl);
                    const pageName = link.querySelector('span').textContent;
                    sessionStorage.setItem('currentPageTitle', pageName);

                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    pageTitle.textContent = pageName;
                    loadPage(pageUrl);

                    if (window.innerWidth < 768) {
                        sidebar.classList.add('-translate-x-full');
                    }
                });

                document.getElementById('profile-name').closest('.nav-link').addEventListener('click', (e) => {
                    const link = e.currentTarget;
                    e.preventDefault();

                    const pageUrl = link.dataset.page;
                    if (!pageUrl)
                        return;

                    sessionStorage.setItem('currentPage', pageUrl);
                    const pageName = link.querySelector('span').textContent;
                    sessionStorage.setItem('currentPageTitle', pageName);

                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    pageTitle.textContent = pageName;
                    loadPage(pageUrl);

                    if (window.innerWidth < 768) {
                        sidebar.classList.add('-translate-x-full');
                    }
                });

                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('-translate-x-full');
                });

                document.getElementById('logout-button').addEventListener('click', () => {
                    sessionStorage.removeItem('loggedInUser');
                    sessionStorage.removeItem('currentPage');
                    sessionStorage.removeItem('currentPageTitle');
                    window.location.href = "login.html";
                });

                notificationBell.addEventListener('click', () => {
                    const notificationLink = document.querySelector('.nav-link[data-page="notifications.html"]');
                    if (notificationLink) {
                        notificationLink.click();
                    }
                });


                const storedPage = sessionStorage.getItem('currentPage');
                const storedPageTitle = sessionStorage.getItem('currentPageTitle');
                let pageToLoad = 'billing_page_integrated.html'; // Default page
                let titleToSet = 'Billing / Invoicing';

                if (storedPage && storedPageTitle) {
                    pageToLoad = storedPage;
                    titleToSet = storedPageTitle;
                    const activeLink = document.querySelector(`.nav-link[data-page="${storedPage}"]`);
                    if (activeLink) {
                        navLinks.forEach(l => l.classList.remove('active'));
                        activeLink.classList.add('active');
                    }
                } else {
                    const defaultBillingLink = document.querySelector('.nav-link[data-page="billing_page_integrated.html"]');
                    if (defaultBillingLink) {
                        defaultBillingLink.classList.add('active');
                    }
                }

                pageTitle.textContent = titleToSet;
                loadPage(pageToLoad);

                window.fetchUnreadNotificationCount();
                setInterval(window.fetchUnreadNotificationCount, 60000);
            })();
        </script>

    </body>
</html>